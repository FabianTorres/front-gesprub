<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<div class="layout-main-container">
    <p-tabView styleClass="w-full">

        <p-tabPanel header="Generador de Carga" leftIcon="pi pi-upload">

            <div class="card border-none shadow-none p-0">
                <h2 class="text-2xl font-semibold mb-4">Generador de Carga de Vectores</h2>
                <p class="text-muted-color mb-4">Gestiona los vectores y valida duplicados antes de exportar el archivo
                    SQL.</p>

                <p-toolbar styleClass="mb-4">
                    <ng-template pTemplate="left">
                        <button pButton pRipple label="Nuevo Vector" icon="pi pi-plus" class="mr-2"
                            (click)="abrirNuevo()"></button>

                        <button pButton pRipple [label]="filtrandoDuplicados() ? 'Ver Todos' : 'Ver Duplicados'"
                            icon="pi pi-filter" class="mr-2"
                            [ngClass]="filtrandoDuplicados() ? 'p-button-warning' : 'p-button-secondary p-button-outlined'"
                            (click)="toggleFiltroDuplicados()"
                            pTooltip="Muestra solo los registros con RUT, Periodo y Vector repetidos"
                            tooltipPosition="top">
                        </button>
                    </ng-template>

                    <ng-template pTemplate="right">
                        <button pButton pRipple label="Ver Historial" icon="pi pi-history"
                            class="p-button-outlined mr-2" (click)="abrirHistorial()">
                        </button>
                        <button pButton pRipple label="Exportar SQL (Batch)" icon="pi pi-database" class="p-button mr-2"
                            (click)="exportarSQL()" pTooltip="Exportar vectores Batch para TR_RESUMEN_TRANS_2010"
                            tooltipPosition="top">
                        </button>

                        <button pButton pRipple label="Exportar TXT (BigData)" icon="pi pi-file" class="p-button mr-2"
                            (click)="exportarTXT()" pTooltip="Exportar vectores BigData para Integración"
                            tooltipPosition="top">
                        </button>
                    </ng-template>
                </p-toolbar>

                <p-table #dt [value]="vectoresVisuales()" [rows]="10" [paginator]="true"
                    [rowsPerPageOptions]="[10, 20, 50, 100]" [loading]="loading" responsiveLayout="scroll"
                    [rowHover]="true" dataKey="id" styleClass="p-datatable-gridlines"
                    [globalFilterFields]="['rut', 'periodo', 'vector', 'valor', 'tipo']">

                    <ng-template pTemplate="caption">
                        <div
                            class="flex flex-column md:flex-row md:justify-content-between md:align-items-center gap-3">
                            <span class="text-xl font-bold text-900">Listado de Vectores</span>

                            <div class="flex gap-2 align-items-center">
                                <button pButton label="Limpiar" class="p-button-outlined p-button-sm"
                                    icon="pi pi-filter-slash" (click)="dt.clear()"></button>
                                <span class="p-input-icon-left">
                                    <i class="pi pi-search"></i>
                                    <input pInputText type="text"
                                        (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                                        placeholder="Buscar..." class="p-inputtext-sm" />
                                </span>
                            </div>
                        </div>
                    </ng-template>

                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="rut" style="min-width: 100px">
                                <div class="flex justify-between items-center">
                                    RUT
                                    <div class="flex align-items-center gap-1">
                                        <p-sortIcon field="rut"></p-sortIcon>
                                        <p-columnFilter type="text" field="rut" display="menu"
                                            placeholder="Buscar RUT"></p-columnFilter>
                                    </div>
                                </div>
                            </th>

                            <th pSortableColumn="periodo" style="min-width: 50px">
                                <div class="flex justify-between items-center">
                                    Periodo
                                    <div class="flex align-items-center gap-1">
                                        <p-sortIcon field="periodo"></p-sortIcon>
                                        <p-columnFilter type="text" field="periodo" display="menu"
                                            placeholder="202600"></p-columnFilter>
                                    </div>
                                </div>
                            </th>

                            <th pSortableColumn="vector" style="min-width: 50px">
                                <div class="flex justify-between items-center">
                                    Vector
                                    <div class="flex align-items-center gap-1">
                                        <p-sortIcon field="vector"></p-sortIcon>
                                        <p-columnFilter type="text" field="vector" display="menu"
                                            placeholder="N° Vector"></p-columnFilter>
                                    </div>
                                </div>
                            </th>

                            <th pSortableColumn="valor" style="min-width: 150px">
                                <div class="flex justify-between items-center">
                                    Valor
                                    <div class="flex align-items-center gap-1">
                                        <p-sortIcon field="valor"></p-sortIcon>
                                        <p-columnFilter type="numeric" field="valor" display="menu"></p-columnFilter>
                                    </div>
                                </div>
                            </th>

                            <th pSortableColumn="tipo">
                                <div class="flex justify-between items-center">
                                    Tipo
                                    <div class="flex align-items-center gap-1">
                                        <p-sortIcon field="tipo"></p-sortIcon>

                                        <p-columnFilter field="tipo" matchMode="equals" display="menu"
                                            [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
                                            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                                <p-dropdown [ngModel]="value" [options]="['BATCH', 'BIGDATA_INTEGRADO']"
                                                    (onChange)="filter($any($event).value)" placeholder="Todos"
                                                    [style]="{'min-width': '100%'}">
                                                    <ng-template let-option pTemplate="item">
                                                        <p-tag [value]="option"
                                                            [severity]="option === 'BATCH' ? 'info' : 'help'"></p-tag>
                                                    </ng-template>
                                                </p-dropdown>
                                            </ng-template>
                                        </p-columnFilter>

                                    </div>
                                </div>
                            </th>

                            <th>RUT 2</th>
                            <th style="width: 120px">Acciones</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-v>
                        <tr>
                            <td class="font-medium">{{v.rut}}-{{v.dv}}</td>
                            <td>
                                {{v.periodo}}
                            </td>
                            <td>
                                <p-tag [value]="v.vector" severity="success"></p-tag>
                            </td>
                            <td>{{v.valor | number}}</td>
                            <td>
                                <p-tag [value]="v.tipo" [severity]="getSeverityTipo(v.vector)"></p-tag>
                            </td>
                            <td>
                                <span *ngIf="v.rut2">{{v.rut2}}-{{v.dv2}}</span>
                                <span *ngIf="!v.rut2" class="text-surface-400 italic">N/A</span>
                            </td>
                            <td>
                                <div class="flex gap-2">
                                    <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded "
                                        (click)="editarVector(v)" pTooltip="Editar" tooltipPosition="top"></button>
                                    <button pButton pRipple icon="pi pi-trash" class="p-button-rounded "
                                        (click)="eliminarVector(v)" pTooltip="Eliminar" tooltipPosition="top"></button>
                                    <i *ngIf="v.usuarioModificacion"
                                        class="pi pi-info-circle text-gray-400 align-self-center cursor-pointer"
                                        [pTooltip]="'Modificado por: ' + v.usuarioModificacion + ' (' + (v.fechaModificacion | date:'short') + ')'"
                                        tooltipPosition="left">
                                    </i>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="empty">
                        <tr>
                            <td colspan="6" class="text-center p-4">No se encontraron vectores con los filtros actuales.
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <div class="flex justify-end mt-3 pr-2" *ngIf="vectores().length > 0">
                    <span class="text-sm font-medium text-surface-600 dark:text-surface-400">
                        Mostrando {{ dt.filteredValue ? dt.filteredValue.length : vectoresVisuales().length }}
                        de {{ vectores().length }} registros totales

                        <span *ngIf="filtrandoDuplicados()" class="font-bold text-orange-500 ml-1">
                            (Modo: Duplicados)
                        </span>
                    </span>
                </div>
            </div>

        </p-tabPanel>
        <p-tabPanel header="Catálogo de Vectores" leftIcon="pi pi-list">
            <div class="card border-none shadow-none p-0">
                <h2 class="text-xl font-bold mb-4">Maestro de Vectores</h2>
                <p class="mb-4">Define qué vectores son Batch y cuáles son BigData Integrados.</p>


                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 2rem;">

                    <div
                        style="flex: 1; min-width: 280px; background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span
                                style="display: block; color: #64748b; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Total
                                de Vectores</span>
                            <div style="color: #1e293b; font-weight: 700; font-size: 2rem; line-height: 1;">{{
                                totalesCatalogo().total }}</div>
                        </div>
                        <div
                            style="display: flex; align-items: center; justify-content: center; background-color: var(--primary-50, #eff6ff); border-radius: 50%; width: 3.5rem; height: 3.5rem;">
                            <i class="pi pi-list text-primary text-2xl"></i>
                        </div>
                    </div>

                    <div
                        style="flex: 1; min-width: 280px; background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #3B82F6; display: flex; flex-direction: column;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                <span
                                    style="display: block; color: #64748b; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Legacy
                                    (Batch)</span>
                                <div style="color: #1e293b; font-weight: 700; font-size: 2rem; line-height: 1;">{{
                                    totalesCatalogo().batch }}</div>
                            </div>
                            <div
                                style="display: flex; align-items: center; justify-content: center; background-color: #DBEAFE; border-radius: 50%; width: 3.5rem; height: 3.5rem;">
                                <i class="pi pi-database text-blue-500 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        style="flex: 1; min-width: 280px; background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #A855F7; display: flex; flex-direction: column;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                <span
                                    style="display: block; color: #64748b; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">BigData
                                    Integrado</span>
                                <div style="color: #1e293b; font-weight: 700; font-size: 2rem; line-height: 1;">{{
                                    totalesCatalogo().bigdata }}</div>
                            </div>
                            <div
                                style="display: flex; align-items: center; justify-content: center; background-color: #F3E8FF; border-radius: 50%; width: 3.5rem; height: 3.5rem;">
                                <i class="pi pi-cloud text-purple-500 text-2xl"></i>
                            </div>
                        </div>

                    </div>

                </div>




                <p-toolbar styleClass="mb-4">
                    <ng-template pTemplate="left">
                        <button pButton label="Nuevo Vector en Catálogo" icon="pi pi-plus" class="p-button"
                            (click)="abrirNuevoCatalogo()"></button>
                    </ng-template>
                </p-toolbar>

                <p-table [value]="catalogo()" [rows]="10" [paginator]="true" styleClass="p-datatable-gridlines">
                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="vectorId">Vector <p-sortIcon field="vectorId"></p-sortIcon></th>
                            <th pSortableColumn="nombre">Nombre <p-sortIcon field="nombre"></p-sortIcon></th>
                            <th pSortableColumn="tipoTecnologia">Tipo <p-sortIcon field="tipoTecnologia"></p-sortIcon>
                            </th>
                            <th style="width: 100px">Acciones</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-cat>
                        <tr>
                            <td class="font-bold"> <p-tag [value]="cat.vectorId" severity="success"></p-tag></td>
                            <td>{{ cat.nombre }}</td>
                            <td>
                                <p-tag [value]="cat.tipoTecnologia"
                                    [severity]="cat.tipoTecnologia === 'BATCH' ? 'info' : 'help'">
                                </p-tag>
                            </td>
                            <td>
                                <button pButton icon="pi pi-pencil" class="p-button-rounded"
                                    (click)="editarCatalogo(cat)"></button>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-tabPanel>
    </p-tabView>
</div>





<p-dialog [(visible)]="vectorDialog" [style]="{width: '600px'}"
    header="{{esEdicion ? 'Editar Vector' : 'Nuevo Vector'}}" [modal]="true" class="p-fluid">

    <ng-template pTemplate="content">

        <div class="formgrid grid">
            <div class="field mb-3 col-9">
                <label for="rut" class="font-bold">RUT Contribuyente</label>
                <p-inputNumber id="rut" [(ngModel)]="vector.rut" [useGrouping]="false" [required]="true"
                    placeholder="Ej: 12345678" [autofocus]="true" styleClass="w-full"></p-inputNumber>
                <small class="p-error block" *ngIf="submitted && !vector.rut">El RUT es requerido.</small>
            </div>
            <div class="field mb-3 col-3">
                <label for="dv" class="font-bold">DV</label>
                <input type="text" pInputText id="dv" [(ngModel)]="vector.dv" maxlength="1" required
                    class="uppercase font-bold w-full" />
                <small class="p-error block" *ngIf="submitted && !vector.dv">Req.</small>
            </div>
        </div>

        <div class="formgrid grid">
            <div class="field mb-3 col-6">
                <label for="periodo" class="font-bold">Periodo (YYYYMM)</label>
                <p-inputNumber id="periodo" [(ngModel)]="vector.periodo" [useGrouping]="false" [min]="200000"
                    [max]="209912" placeholder="Ej: 202600" styleClass="w-full"></p-inputNumber>
                <small class="p-error block" *ngIf="submitted && !vector.periodo">Requerido.</small>
            </div>
            <div class="field mb-3 col-6">
                <label for="vectorNum" class="block font-bold mb-2">Vector</label>
                <p-select [options]="catalogo()" [(ngModel)]="vector.vector" optionLabel="vectorId"
                    optionValue="vectorId" [filter]="true" filterBy="vectorId,nombre" placeholder="Seleccione Vector"
                    styleClass="w-full" appendTo="body" [virtualScroll]="true" [virtualScrollItemSize]="65">

                    <ng-template pTemplate="selectedItem" let-selectedOption>
                        <div class="flex align-items-center gap-2" *ngIf="selectedOption">
                            <div>{{ selectedOption.vectorId }} - {{ selectedOption.tipoTecnologia }}</div>
                        </div>
                    </ng-template>

                    <ng-template let-v pTemplate="item">
                        <div class="flex flex-column">
                            <span class="font-bold">{{ v.vectorId }} - {{ v.tipoTecnologia }}</span>
                            <!-- <span class="text-sm text-gray-500">{{ v.tipoTecnologia }}</span> -->
                        </div>
                    </ng-template>
                </p-select>
                <small class="p-error block" *ngIf="submitted && !vector.vector">Requerido.</small>
            </div>
        </div>

        <div class="field mb-3">
            <label for="valor" class="block font-bold mb-2">Valor</label>
            <p-inputNumber id="valor" [(ngModel)]="vector.valor" mode="decimal" [minFractionDigits]="0"
                [maxFractionDigits]="2" placeholder="0" styleClass="w-full"></p-inputNumber>
        </div>

        <div class="field mb-3">
            <label for="desc" class="block font-bold mb-2">Descripción</label>
            <input type="text" [disabled]="true" pInputText id="desc" [(ngModel)]="vector.elvc_seq" placeholder="NOMCES"
                class="w-full" />
        </div>

        <p-fieldset legend="Datos Secundarios (Opcional)" [toggleable]="true" [collapsed]="true">
            <div class="formgrid grid mt-2">
                <div class="field col-9 m-0">
                    <label for="rut2">RUT 2</label>
                    <p-inputNumber id="rut2" [(ngModel)]="vector.rut2" [useGrouping]="false" placeholder="Ej: 99888777"
                        styleClass="w-full"></p-inputNumber>
                </div>
                <div class="field col-3 m-0">
                    <label for="dv2">DV 2</label>
                    <input type="text" pInputText id="dv2" [(ngModel)]="vector.dv2" maxlength="1"
                        class="uppercase text-center font-bold w-full" />
                </div>
            </div>
        </p-fieldset>

    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="vectorDialog = false"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text"
            (click)="guardarVector()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="logDialog" header="Historial de Cambios" [modal]="true" [style]="{width: '900px'}"
    [maximizable]="true">
    <div class="card">
        <p-table [value]="logs()" [rows]="10" [paginator]="true" [loading]="loadingLogs"
            styleClass="p-datatable-sm p-datatable-striped" responsiveLayout="scroll">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="logFecha">Fecha <p-sortIcon field="logFecha"></p-sortIcon></th>
                    <th pSortableColumn="logUsuario">Usuario <p-sortIcon field="logUsuario"></p-sortIcon></th>
                    <th pSortableColumn="tipoAccion">Acción <p-sortIcon field="tipoAccion"></p-sortIcon></th>
                    <th>RUT</th>
                    <th>Periodo</th>
                    <th pSortableColumn="vector">Vector / Tipo <p-sortIcon field="vector"></p-sortIcon></th>
                    <th>Valor</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-log>
                <tr>
                    <td>{{ log.logFecha | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td class="font-bold">{{ log.logUsuario }}</td>
                    <td>
                        <p-tag [value]="log.tipoAccion" [severity]="getSeverityAccion(log.tipoAccion)"></p-tag>
                    </td>
                    <td>{{ log.rut }}-{{ log.dv }}</td>
                    <td>{{ log.periodo }}</td>
                    <td>
                        <div class="flex align-items-center gap-2">
                            <span class="font-bold text-lg">{{ log.vector }}</span>
                            <p-tag [value]="getTipoVector(log.vector)" [severity]="getSeverityTipo(log.vector)">
                            </p-tag>
                        </div>
                    </td>
                    <td class="text-right font-mono">{{ log.valor | number }}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="empty">
                <tr>
                    <td colspan="7" class="text-center p-4">No hay registros de auditoría.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" class="p-button-text"
            (click)="logDialog = false"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="catalogoDialog" [style]="{width: '450px'}" header="Detalle Vector Catálogo" [modal]="true"
    class="p-fluid">
    <ng-template pTemplate="content">
        <div class="field mb-3">
            <label for="catId" class="font-bold">Vector</label>
            <p-inputNumber id="catId" [(ngModel)]="catalogoItem.vectorId" [disabled]="esEdicionCatalogo"
                class="w-full"></p-inputNumber>
        </div>
        <div class="field mb-3">
            <label for="catNombre" class="font-bold">Nombre</label>
            <input type="text" pInputText id="catNombre" [(ngModel)]="catalogoItem.nombre" class="w-full" />
        </div>
        <div class="field mb-3">
            <label class="font-bold block mb-2">Tipo</label>
            <div class="flex gap-3">
                <div class="flex align-items-center">
                    <p-radioButton name="tecnologia" value="BATCH" [(ngModel)]="catalogoItem.tipoTecnologia"
                        inputId="rb1"></p-radioButton>
                    <label for="rb1" class="ml-2">Batch (Legacy)</label>
                </div>
                <div class="flex align-items-center">
                    <p-radioButton name="tecnologia" value="BIGDATA_INTEGRADO" [(ngModel)]="catalogoItem.tipoTecnologia"
                        inputId="rb2"></p-radioButton>
                    <label for="rb2" class="ml-2">BigData Integrado</label>
                </div>
            </div>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="catalogoDialog = false"></button>
        <button pButton label="Guardar" icon="pi pi-check" class="p-button-text" (click)="guardarCatalogo()"></button>
    </ng-template>
</p-dialog>