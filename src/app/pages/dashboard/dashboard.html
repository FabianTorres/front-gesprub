<div class="card">
    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">

    
        <h2 class="text-2xl font-semibold mb-4">Visión General del Proyecto</h2>

        <div *ngIf="componentes().length > 0">
                <p-select [options]="componentes()"
                        [(ngModel)]="componenteSeleccionadoId"
                        optionLabel="nombre_componente"
                        optionValue="id_componente"
                        placeholder="Filtrar por Componente..."
                        [showClear]="true"
                        styleClass="w-full md:w-20rem">
                </p-select>
        </div>
    </div>
    <div *ngIf="cargando()" class="text-center p-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        <p class="mt-2">Cargando datos del dashboard...</p>
    </div>

    <div *ngIf="!cargando() && !dashboardData()">
        <p class="text-center text-lg text-surface-500">Por favor, selecciona un proyecto para ver sus métricas.</p>
    </div>

    <div *ngIf="!cargando() && dashboardData() as data" class="grid gap-4">
        
        <!-- KPIs Principales -->
        <div class="col-12 md:col-6 lg:col-3">
            <app-kpi-card
                titulo="Avance General"
                [valor]="data.kpis.porcentajeAvance"
                icono="pi pi-chart-line"
                unidad="%"
                color="bg-blue-500">
            </app-kpi-card>
        </div>
        <div class="col-12 md:col-6 lg:col-3">
            <app-kpi-card
                titulo="Casos Totales"
                [valor]="data.kpis.totalCasos"
                icono="pi pi-file"
                color="bg-purple-500">
            </app-kpi-card>
        </div>
        <div class="col-12 md:col-6 lg:col-3">
             <app-kpi-card
                titulo="Casos Ejecutados"
                [valor]="data.kpis.casosEjecutados"
                icono="pi pi-check"
                color="bg-green-500">
            </app-kpi-card>
        </div>
        <div class="col-12 md:col-6 lg:col-3">
             <app-kpi-card
                titulo="Casos Pendientes"
                [valor]="data.kpis.casosPendientes"
                icono="pi pi-clock"
                color="bg-orange-500">
            </app-kpi-card>
        </div>

        <!-- Gráficos y Tablas -->
        <div class="col-12 lg:col-5">
            <p-card>
                <ng-template pTemplate="title">
                    <div class="flex items-center">
                        <i class="pi pi-chart-pie mr-2"></i>
                        <span>Distribución de Estados</span>
                    </div>
                </ng-template>
                <div class="flex justify-center">
                    <p-chart type="doughnut" [data]="chartData" [options]="chartOptions" styleClass="w-full md:w-[30rem]"></p-chart>
                </div>
            </p-card>
        </div>

        <div class="col-12 lg:col-7">
            <p-card>
                 <ng-template pTemplate="title">
                    <div class="flex items-center">
                        <i class="pi pi-history mr-2"></i>
                        <span>Actividad Reciente</span>
                    </div>
                </ng-template>
                <p-table [value]="data.actividadReciente" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '50rem'}">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Caso de Prueba</th>
                            <th>Estado</th>
                            <th>Certificador</th>
                            <th>Fecha</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-actividad>
                        <tr>
                            <td>
                                <a [routerLink]="['/pages/casos', actividad.idCaso]" class="text-primary-500 hover:underline">
                                    {{ actividad.nombreCaso }}
                                </a>
                            </td>
                            <td><p-tag [value]="actividad.estado" [severity]="getSeverityForEstado(actividad.estado)"></p-tag></td>
                            <td>{{ actividad.nombreTester }}</td>
                            <td>{{ formatRelativeTime(actividad.fechaEjecucion) }}</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="4" class="text-center">No hay actividad reciente para mostrar.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>

    </div>
</div>

